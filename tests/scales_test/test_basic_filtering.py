import os

import requests
import unittest

from helper_func import make_results_url
import json

class TestFilter(unittest.TestCase):

    def setUp(self):

        self.apikey = os.environ.get("API_KEY", "thisisatestkey")
        self.url = os.environ.get("TEST_URL", "http://127.0.0.1:5000/")
        self.ringid = "90e114c2-ef05-490c-bdd8-f6f271a6733f"
        self.versionid = "1"
        self.headers ={
            "x-api-key": self.apikey
        }
    
    def test_filter_year(self):
        # ground truth verified
        opts = {"year": "2016"}

        urllink = make_results_url(self.url, self.ringid, self.versionid, "Case", "results", opts)

        resp = requests.get(urllink, headers=self.headers)
        results = json.loads(resp.content.decode('utf-8'))

        expected_results = {"totalCount": 346019, "page": 0, "batchSize": 10, "activeCacheRange": [0, 100], "results": [{"case_id": "2:16-cr-00105", "ucid": "flmd;;2:16-cr-00105", "header_case_id": "2:16-cr-00105-UA-MRM-1", "lead_case_pacer_id": "None", "lead_case_id": "None", "member_case_key": "None", "case_pacer_id": "None", "recap_id": "None", "monetary_demand": "None", "mdl_code": "None", "billable_pages": "1", "is_mdl": "False", "is_multi": "False", "filing_date": "2016-09-22", "terminating_date": "2016-09-23", "download_timestamp": "2020-02-01 09:36:52", "year": "2016", "case_name": "USA v. Johnson", "jury_demand": "None", "cause": "None", "jurisdiction": "None", "case_flags": "['CLOSED']", "case_duration": "1", "judge": "None", "referred_judges": "None", "case_type_id": "2", "city_id": "98", "court_id": "28", "nature_suit_id": "None", "state_id": "19", "case_status": "closed", "filed_in_error_text": "None", "mdl_id_source": "None", "source": "pacer", "cost": "0.1", "n_docket_reports": "1", "download_url": "None", "docket_available": "True"}, {"case_id": "2:16-cr-00106", "ucid": "flmd;;2:16-cr-00106", "header_case_id": "2:16-cr-00106-SPC-CM-1", "lead_case_pacer_id": "None", "lead_case_id": "None", "member_case_key": "None", "case_pacer_id": "None", "recap_id": "None", "monetary_demand": "None", "mdl_code": "None", "billable_pages": "2", "is_mdl": "False", "is_multi": "False", "filing_date": "2016-09-23", "terminating_date": "2016-09-23", "download_timestamp": "2020-02-01 09:36:54", "year": "2016", "case_name": "USA v. Palma-Campos", "jury_demand": "None", "cause": "None", "jurisdiction": "None", "case_flags": "None", "case_duration": "0", "judge": "None", "referred_judges": "None", "case_type_id": "2", "city_id": "98", "court_id": "28", "nature_suit_id": "None", "state_id": "19", "case_status": "closed", "filed_in_error_text": "None", "mdl_id_source": "None", "source": "pacer", "cost": "0.2", "n_docket_reports": "1", "download_url": "None", "docket_available": "True"}, {"case_id": "2:16-cr-00107", "ucid": "flmd;;2:16-cr-00107", "header_case_id": "2:16-cr-00107-JES-CM-1", "lead_case_pacer_id": "None", "lead_case_id": "None", "member_case_key": "None", "case_pacer_id": "None", "recap_id": "None", "monetary_demand": "None", "mdl_code": "None", "billable_pages": "1", "is_mdl": "False", "is_multi": "False", "filing_date": "2016-09-23", "terminating_date": "2016-09-23", "download_timestamp": "2020-02-01 09:36:56", "year": "2016", "case_name": "USA v. Leisinger", "jury_demand": "None", "cause": "None", "jurisdiction": "None", "case_flags": "['CLOSED']", "case_duration": "0", "judge": "None", "referred_judges": "None", "case_type_id": "2", "city_id": "98", "court_id": "28", "nature_suit_id": "None", "state_id": "19", "case_status": "closed", "filed_in_error_text": "None", "mdl_id_source": "None", "source": "pacer", "cost": "0.1", "n_docket_reports": "1", "download_url": "None", "docket_available": "True"}, {"case_id": "2:16-cr-00108", "ucid": "flmd;;2:16-cr-00108", "header_case_id": "2:16-cr-00108-SPC-CM-1", "lead_case_pacer_id": "None", "lead_case_id": "None", "member_case_key": "None", "case_pacer_id": "None", "recap_id": "None", "monetary_demand": "None", "mdl_code": "None", "billable_pages": "4", "is_mdl": "False", "is_multi": "False", "filing_date": "2016-09-28", "terminating_date": "2017-10-03", "download_timestamp": "2020-02-01 09:36:59", "year": "2016", "case_name": "USA v. Dicks", "jury_demand": "None", "cause": "None", "jurisdiction": "None", "case_flags": "['CLOSED']", "case_duration": "370", "judge": "None", "referred_judges": "None", "case_type_id": "2", "city_id": "98", "court_id": "28", "nature_suit_id": "None", "state_id": "19", "case_status": "closed", "filed_in_error_text": "None", "mdl_id_source": "None", "source": "pacer", "cost": "0.4", "n_docket_reports": "1", "download_url": "None", "docket_available": "True"}, {"case_id": "2:16-cr-00109", "ucid": "flmd;;2:16-cr-00109", "header_case_id": "2:16-cr-00109-JES-CM-1", "lead_case_pacer_id": "None", "lead_case_id": "None", "member_case_key": "None", "case_pacer_id": "None", "recap_id": "None", "monetary_demand": "None", "mdl_code": "None", "billable_pages": "7", "is_mdl": "False", "is_multi": "False", "filing_date": "2016-09-28", "terminating_date": "2018-11-13", "download_timestamp": "2020-02-01 09:37:01", "year": "2016", "case_name": "USA v. Mendleski", "jury_demand": "None", "cause": "None", "jurisdiction": "None", "case_flags": "['CLOSED']", "case_duration": "776", "judge": "None", "referred_judges": "None", "case_type_id": "2", "city_id": "98", "court_id": "28", "nature_suit_id": "None", "state_id": "19", "case_status": "closed", "filed_in_error_text": "None", "mdl_id_source": "None", "source": "pacer", "cost": "0.7", "n_docket_reports": "1", "download_url": "None", "docket_available": "True"}, {"case_id": "2:16-cr-00111", "ucid": "flmd;;2:16-cr-00111", "header_case_id": "2:16-cr-00111-SPC-MRM-1", "lead_case_pacer_id": "None", "lead_case_id": "None", "member_case_key": "None", "case_pacer_id": "None", "recap_id": "None", "monetary_demand": "None", "mdl_code": "None", "billable_pages": "4", "is_mdl": "False", "is_multi": "False", "filing_date": "2016-09-28", "terminating_date": "2017-09-26", "download_timestamp": "2020-02-01 09:37:03", "year": "2016", "case_name": "USA v. Gladys", "jury_demand": "None", "cause": "None", "jurisdiction": "None", "case_flags": "['CLOSED']", "case_duration": "363", "judge": "None", "referred_judges": "None", "case_type_id": "2", "city_id": "98", "court_id": "28", "nature_suit_id": "None", "state_id": "19", "case_status": "closed", "filed_in_error_text": "None", "mdl_id_source": "None", "source": "pacer", "cost": "0.4", "n_docket_reports": "1", "download_url": "None", "docket_available": "True"}, {"case_id": "2:16-cr-00112", "ucid": "flmd;;2:16-cr-00112", "header_case_id": "2:16-cr-00112-SPC-CM-1", "lead_case_pacer_id": "None", "lead_case_id": "None", "member_case_key": "None", "case_pacer_id": "None", "recap_id": "None", "monetary_demand": "None", "mdl_code": "None", "billable_pages": "3", "is_mdl": "False", "is_multi": "False", "filing_date": "2016-09-28", "terminating_date": "2017-02-08", "download_timestamp": "2020-02-01 09:37:06", "year": "2016", "case_name": "USA v. Teyul-Tut", "jury_demand": "None", "cause": "None", "jurisdiction": "None", "case_flags": "['CLOSED']", "case_duration": "133", "judge": "None", "referred_judges": "None", "case_type_id": "2", "city_id": "98", "court_id": "28", "nature_suit_id": "None", "state_id": "19", "case_status": "closed", "filed_in_error_text": "None", "mdl_id_source": "None", "source": "pacer", "cost": "0.3", "n_docket_reports": "1", "download_url": "None", "docket_available": "True"}, {"case_id": "2:16-cr-00113", "ucid": "flmd;;2:16-cr-00113", "header_case_id": "2:16-cr-00113-SPC-MRM-1", "lead_case_pacer_id": "None", "lead_case_id": "None", "member_case_key": "None", "case_pacer_id": "None", "recap_id": "None", "monetary_demand": "None", "mdl_code": "None", "billable_pages": "3", "is_mdl": "False", "is_multi": "False", "filing_date": "2016-09-28", "terminating_date": "2017-04-12", "download_timestamp": "2020-02-01 09:37:08", "year": "2016", "case_name": "USA v. Barahona-Funes", "jury_demand": "None", "cause": "None", "jurisdiction": "None", "case_flags": "['CLOSED', 'INTERPRETER']", "case_duration": "196", "judge": "None", "referred_judges": "None", "case_type_id": "2", "city_id": "98", "court_id": "28", "nature_suit_id": "None", "state_id": "19", "case_status": "closed", "filed_in_error_text": "None", "mdl_id_source": "None", "source": "pacer", "cost": "0.3", "n_docket_reports": "1", "download_url": "None", "docket_available": "True"}, {"case_id": "2:16-cr-00114", "ucid": "flmd;;2:16-cr-00114", "header_case_id": "2:16-cr-00114-SPC-CM-1", "lead_case_pacer_id": "None", "lead_case_id": "None", "member_case_key": "None", "case_pacer_id": "None", "recap_id": "None", "monetary_demand": "None", "mdl_code": "None", "billable_pages": "3", "is_mdl": "False", "is_multi": "False", "filing_date": "2016-09-28", "terminating_date": "2017-04-04", "download_timestamp": "2020-02-01 09:37:10", "year": "2016", "case_name": "USA v. Posey", "jury_demand": "None", "cause": "None", "jurisdiction": "None", "case_flags": "['CLOSED']", "case_duration": "188", "judge": "None", "referred_judges": "None", "case_type_id": "2", "city_id": "98", "court_id": "28", "nature_suit_id": "None", "state_id": "19", "case_status": "closed", "filed_in_error_text": "None", "mdl_id_source": "None", "source": "pacer", "cost": "0.3", "n_docket_reports": "1", "download_url": "None", "docket_available": "True"}, {"case_id": "2:16-cr-00115", "ucid": "flmd;;2:16-cr-00115", "header_case_id": "2:16-cr-00115-JES-MRM-1", "lead_case_pacer_id": "None", "lead_case_id": "None", "member_case_key": "None", "case_pacer_id": "None", "recap_id": "None", "monetary_demand": "None", "mdl_code": "None", "billable_pages": "5", "is_mdl": "False", "is_multi": "False", "filing_date": "2016-09-28", "terminating_date": "2017-11-14", "download_timestamp": "2020-02-01 09:37:12", "year": "2016", "case_name": "USA v. Patterson", "jury_demand": "None", "cause": "None", "jurisdiction": "None", "case_flags": "['CLOSED']", "case_duration": "412", "judge": "None", "referred_judges": "None", "case_type_id": "2", "city_id": "98", "court_id": "28", "nature_suit_id": "None", "state_id": "19", "case_status": "closed", "filed_in_error_text": "None", "mdl_id_source": "None", "source": "pacer", "cost": "0.5", "n_docket_reports": "1", "download_url": "None", "docket_available": "True"}]}
        self.assertEqual(expected_results, results)

if __name__ == '__main__':
    unittest.main()